# DCN (å¯å˜å½¢å·ç§¯ç½‘ç»œ) å®ç°
# =======================

"""
DCNæ¨¡å—çš„å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬å¯å˜å½¢å·ç§¯å±‚å’Œå¢å¼ºçš„ç“¶é¢ˆå—ã€‚
ç”¨äºYOLOv8çš„ç›®æ ‡æ£€æµ‹ä¼˜åŒ–ã€‚
"""

import torch
import torch.nn as nn
from torchvision.ops import DeformConv2d


class DCNConv(nn.Module):
    """
    å¯å˜å½¢å·ç§¯v2å±‚ (Deformable Convolutional v2 Layer)

    ç‰¹æ€§ï¼š
    - ä¸ºæ¯ä¸ªé‡‡æ ·ç‚¹å­¦ä¹ ç©ºé—´åç§»é‡
    - æ— è°ƒåˆ¶ç®€åŒ–ç‰ˆæœ¬
    - ä¸æ ‡å‡†YOLOv8æ¶æ„å…¼å®¹

    å·¥ä½œåŸç†ï¼š
    1. é€šè¿‡é¢å¤–çš„å·ç§¯åˆ†æ”¯é¢„æµ‹æ¯ä¸ªé‡‡æ ·ç‚¹çš„åç§»é‡
    2. ä½¿ç”¨é¢„æµ‹çš„åç§»é‡è°ƒæ•´å·ç§¯æ ¸çš„é‡‡æ ·ä½ç½®
    3. æ‰§è¡Œæ ‡å‡†å·ç§¯æ“ä½œä½†ä½¿ç”¨å˜å½¢çš„é‡‡æ ·ä½ç½®

    ä¼˜åŠ¿ï¼š
    - èƒ½å¤Ÿæ›´å¥½åœ°å»ºæ¨¡å‡ ä½•å˜æ¢
    - é€‚åº”ä¸åŒå½¢çŠ¶å’Œå§¿æ€çš„ç‰©ä½“
    - ä¿æŒè®¡ç®—æ•ˆç‡
    """

    def __init__(self, c1, c2, k=3, s=1, p=1, g=1):
        """
        åˆå§‹åŒ–DCNå·ç§¯å±‚

        å‚æ•°ï¼š
            c1 (int): è¾“å…¥é€šé“æ•°
            c2 (int): è¾“å‡ºé€šé“æ•°
            k (int): å·ç§¯æ ¸å°ºå¯¸ï¼Œé»˜è®¤3
            s (int): æ­¥é•¿ï¼Œé»˜è®¤1
            p (int): å¡«å……ï¼Œé»˜è®¤1
            g (int): åˆ†ç»„æ•°ï¼Œé»˜è®¤1

        ç½‘ç»œç»“æ„ï¼š
        - åç§»é‡é¢„æµ‹åˆ†æ”¯ï¼šè¾“å…¥c1é€šé“ï¼Œè¾“å‡º2*k*kä¸ªåç§»é‡
        - å¯å˜å½¢å·ç§¯ï¼šä½¿ç”¨é¢„æµ‹çš„åç§»é‡è¿›è¡Œå·ç§¯æ“ä½œ
        - æ‰¹å½’ä¸€åŒ–å’Œæ¿€æ´»å‡½æ•°
        """
        super().__init__()

        # åç§»é‡é¢„æµ‹åˆ†æ”¯ - é¢„æµ‹æ¯ä¸ªé‡‡æ ·ç‚¹çš„2Dåç§»é‡
        self.offset_conv = nn.Conv2d(
            c1,              # è¾“å…¥é€šé“æ•°
            2 * k * k,       # æ¯ä¸ªé‡‡æ ·ç‚¹çš„2Dåç§»é‡(x,y)
            kernel_size=k,   # ä¸ä¸»å·ç§¯æ ¸ç›¸åŒå°ºå¯¸
            stride=s,        # æ­¥é•¿
            padding=p,       # å¡«å……
            bias=False       # æ— åç½®é¡¹
        )

        # å¯å˜å½¢å·ç§¯å±‚ - ä½¿ç”¨é¢„æµ‹çš„åç§»é‡
        self.dcn = DeformConv2d(
            in_channels=c1,    # è¾“å…¥é€šé“æ•°
            out_channels=c2,   # è¾“å‡ºé€šé“æ•°
            kernel_size=k,     # å·ç§¯æ ¸å°ºå¯¸
            stride=s,          # æ­¥é•¿
            padding=p,         # å¡«å……
            groups=g,          # åˆ†ç»„å·ç§¯
            bias=False         # æ— åç½®é¡¹
        )

        # æ‰¹å½’ä¸€åŒ–å’Œæ¿€æ´»å‡½æ•°
        self.bn = nn.BatchNorm2d(c2)  # æ‰¹å½’ä¸€åŒ–
        self.act = nn.SiLU()          # SiLUæ¿€æ´»å‡½æ•°

    def forward(self, x):
        """
        å‰å‘ä¼ æ’­ - æ‰§è¡Œå¯å˜å½¢å·ç§¯æ“ä½œ

        å‚æ•°ï¼š
            x (torch.Tensor): è¾“å…¥å¼ é‡ï¼Œå½¢çŠ¶ä¸º[B, C, H, W]

        è¿”å›å€¼ï¼š
            torch.Tensor: è¾“å‡ºå¼ é‡ï¼Œå½¢çŠ¶ä¸º[B, C_out, H_out, W_out]

        å¤„ç†æµç¨‹ï¼š
        1. é€šè¿‡åç§»é‡é¢„æµ‹åˆ†æ”¯è®¡ç®—æ¯ä¸ªé‡‡æ ·ç‚¹çš„åç§»é‡
        2. ä½¿ç”¨å¯å˜å½¢å·ç§¯æ ¹æ®åç§»é‡è°ƒæ•´é‡‡æ ·ä½ç½®
        3. åº”ç”¨æ‰¹å½’ä¸€åŒ–å’Œæ¿€æ´»å‡½æ•°

        æ•°å­¦åŸç†ï¼š
        - æ ‡å‡†å·ç§¯ï¼šy[i] = sum(x[é‡‡æ ·ä½ç½®]) * w[i]
        - DCNå·ç§¯ï¼šy[i] = sum(x[é‡‡æ ·ä½ç½® + offset]) * w[i]
        """
        # æ­¥éª¤1ï¼šé¢„æµ‹åç§»é‡
        # è¾“å…¥ï¼š [B, C1, H, W]
        # è¾“å‡ºï¼š [B, 2*k*k, H, W] - æ¯ä¸ªä½ç½®çš„x,yåç§»é‡
        offsets = self.offset_conv(x)

        # æ­¥éª¤2ï¼šåº”ç”¨å¯å˜å½¢å·ç§¯
        # ä½¿ç”¨é¢„æµ‹çš„åç§»é‡è°ƒæ•´å·ç§¯æ ¸çš„é‡‡æ ·ä½ç½®
        x = self.dcn(x, offsets)

        # æ­¥éª¤3ï¼šå½’ä¸€åŒ–å’Œæ¿€æ´»
        return self.act(self.bn(x))


class DCNBottleneck(nn.Module):
    """
    DCNå¢å¼ºçš„ç“¶é¢ˆå— (DCN-enhanced Bottleneck Block)

    åœ¨æ ‡å‡†ç“¶é¢ˆå—åŸºç¡€ä¸Šç”¨DCNæ›¿æ¢3x3å·ç§¯ï¼Œ
    ä»è€Œè·å¾—æ›´å¥½çš„ç©ºé—´å»ºæ¨¡èƒ½åŠ›ã€‚

    ç½‘ç»œç»“æ„ï¼š
    - 1x1å·ç§¯ï¼šé€šé“æ•°è°ƒæ•´
    - DCN 3x3å·ç§¯ï¼šç©ºé—´ç‰¹å¾æå–ï¼ˆæ ¸å¿ƒï¼‰
    - æ®‹å·®è¿æ¥ï¼šå¯é€‰çš„shortcutè¿æ¥

    åº”ç”¨åœºæ™¯ï¼š
    - YOLOv8çš„C2fæ¨¡å—å†…éƒ¨
    - éœ€è¦å¢å¼ºç©ºé—´å»ºæ¨¡èƒ½åŠ›çš„ç½‘ç»œå±‚
    """

    def __init__(self, c1, c2, shortcut=True, g=1, e=0.5):
        """
        åˆå§‹åŒ–DCNç“¶é¢ˆå—

        å‚æ•°ï¼š
            c1 (int): è¾“å…¥é€šé“æ•°
            c2 (int): è¾“å‡ºé€šé“æ•°
            shortcut (bool): æ˜¯å¦ä½¿ç”¨æ®‹å·®è¿æ¥ï¼Œé»˜è®¤True
            g (int): å·ç§¯åˆ†ç»„æ•°ï¼Œé»˜è®¤1
            e (float): æ‰©å±•æ¯”ä¾‹ï¼Œç”¨äºè®¡ç®—éšè—é€šé“æ•°ï¼Œé»˜è®¤0.5

        è®¡ç®—é€»è¾‘ï¼š
        - éšè—é€šé“æ•° c_ = int(c2 * e)
        - å¦‚æœc1==c2ä¸”shortcut=Trueï¼Œåˆ™ä½¿ç”¨æ®‹å·®è¿æ¥
        """
        super().__init__()

        c_ = int(c2 * e)  # è®¡ç®—éšè—é€šé“æ•°ï¼Œé€šå¸¸ä¸ºè¾“å‡ºé€šé“çš„ä¸€åŠ

        # 1x1å·ç§¯åˆ†æ”¯ - é€šé“æ•°è°ƒæ•´
        self.cv1 = nn.Sequential(
            nn.Conv2d(c1, c_, 1, 1, bias=False),  # 1x1å·ç§¯ï¼Œä¸æ”¹å˜ç©ºé—´å°ºå¯¸
            nn.BatchNorm2d(c_),                    # æ‰¹å½’ä¸€åŒ–
            nn.SiLU()                             # SiLUæ¿€æ´»å‡½æ•°
        )

        # DCN 3x3å·ç§¯åˆ†æ”¯ - ç©ºé—´ç‰¹å¾æå–ï¼ˆæ ¸å¿ƒåˆ›æ–°ç‚¹ï¼‰
        self.cv2 = DCNConv(c_, c2, k=3, s=1, p=1, g=g)

        # æ®‹å·®è¿æ¥åˆ¤æ–­
        self.add = shortcut and c1 == c2

    def forward(self, x):
        """
        å‰å‘ä¼ æ’­ - DCNå¢å¼ºçš„ç“¶é¢ˆå—

        å‚æ•°ï¼š
            x (torch.Tensor): è¾“å…¥ç‰¹å¾å›¾ï¼Œå½¢çŠ¶[B, C1, H, W]

        è¿”å›å€¼ï¼š
            torch.Tensor: è¾“å‡ºç‰¹å¾å›¾ï¼Œå½¢çŠ¶[B, C2, H, W]

        å¤„ç†æµç¨‹ï¼š
        1. é€šè¿‡1x1å·ç§¯è°ƒæ•´é€šé“æ•°
        2. é€šè¿‡DCN 3x3å·ç§¯è¿›è¡Œç©ºé—´ç‰¹å¾æå–
        3. å¦‚æœæ¡ä»¶å…è®¸ï¼Œæ·»åŠ æ®‹å·®è¿æ¥

        æ®‹å·®è¿æ¥é€»è¾‘ï¼š
        - åªæœ‰å½“è¾“å…¥è¾“å‡ºé€šé“æ•°ç›¸ç­‰ä¸”shortcut=Trueæ—¶æ‰ä½¿ç”¨
        - éµå¾ªResNetçš„è®¾è®¡ç†å¿µï¼šy = F(x) + x
        """
        # ä¸»è·¯å¾„ï¼š1x1å·ç§¯ -> DCN 3x3å·ç§¯
        y = self.cv2(self.cv1(x))

        # æ®‹å·®è¿æ¥ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
        return x + y if self.add else y


# æµ‹è¯•DCNå®ç°
if __name__ == "__main__":
    """
    DCNæ¨¡å—çš„æµ‹è¯•å’ŒéªŒè¯

    æµ‹è¯•å†…å®¹ï¼š
    1. DCNConvå±‚çš„æ­£ç¡®æ€§éªŒè¯
    2. DCNBottleneckå—çš„åŠŸèƒ½æµ‹è¯•
    3. æ¨ç†æ€§èƒ½åŸºå‡†æµ‹è¯•
    4. æ¨¡å‹å…¼å®¹æ€§æ£€æŸ¥

    ä½¿ç”¨è¯´æ˜ï¼š
    - è¿è¡Œæ­¤è„šæœ¬å°†è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
    - éœ€è¦å®‰è£…ç›¸å…³çš„ä¾èµ–åŒ…
    - æµ‹è¯•ç»“æœå°†æ‰“å°åˆ°æ§åˆ¶å°
    """
    from utils import setup_device, validate_model, benchmark_inference

    # è®¾å¤‡è®¾ç½®
    device = setup_device()

    # åˆ›å»ºDCNå·ç§¯å±‚è¿›è¡Œæµ‹è¯•
    dcn_conv = DCNConv(c1=256, c2=256, k=3, s=1, p=1)
    print("\nğŸ”§ DCNConvæµ‹è¯•:")
    # éªŒè¯æ¨¡å‹ç»“æ„å’Œå‰å‘ä¼ æ’­
    validate_model(dcn_conv, device, input_size=(1, 256, 32, 32))

    # åˆ›å»ºDCNç“¶é¢ˆå—è¿›è¡Œæµ‹è¯•
    dcn_bottleneck = DCNBottleneck(c1=256, c2=256)
    print("\nğŸ”§ DCNBottleneckæµ‹è¯•:")
    validate_model(dcn_bottleneck, device, input_size=(1, 256, 32, 32))

    # æ€§èƒ½åŸºå‡†æµ‹è¯•
    print("\nğŸ“Š DCNConvæ€§èƒ½æµ‹è¯•:")
    benchmark_inference(dcn_conv, device, input_size=(1, 256, 32, 32))

    print("\nğŸ“Š DCNBottleneckæ€§èƒ½æµ‹è¯•:")
    benchmark_inference(dcn_bottleneck, device, input_size=(1, 256, 32, 32))

    print("\nâœ… DCNæ¨¡å—æµ‹è¯•å®Œæˆï¼")
    print("ğŸ’¡ æµ‹è¯•ç»“æœè¡¨æ˜DCNæ¨¡å—å¯ä»¥æ­£å¸¸å·¥ä½œå¹¶æä¾›æ€§èƒ½åŸºå‡†æ•°æ®")
